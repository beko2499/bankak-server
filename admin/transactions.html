<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª - Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø¨Ù†ÙƒÙƒ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, sans-serif;
        }

        body {
            background: #f5f6fa;
            min-height: 100vh;
        }

        .navbar {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar h1 {
            font-size: 24px;
        }

        .navbar-links a {
            color: white;
            text-decoration: none;
            margin-right: 20px;
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        .navbar-links a:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .container {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-header h2 {
            color: #1a1a2e;
            font-size: 28px;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
            text-align: center;
        }

        .stat-box h4 {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .stat-box .value {
            font-size: 28px;
            font-weight: bold;
            color: #1a1a2e;
        }

        .stat-box.transfers {
            border-top: 4px solid #28a745;
        }

        .stat-box.recharges {
            border-top: 4px solid #e94560;
        }

        .stat-box.total {
            border-top: 4px solid #ffc107;
        }

        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }

        .card-header {
            padding: 20px 25px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h3 {
            color: #1a1a2e;
            font-size: 18px;
        }

        .filter-tabs {
            display: flex;
            gap: 10px;
        }

        .filter-tab {
            padding: 8px 20px;
            border: none;
            background: #f0f0f0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-tab.active {
            background: #e94560;
            color: white;
        }

        .card-body {
            padding: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 15px 20px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            color: #666;
            font-weight: 600;
            font-size: 14px;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-transfer {
            background: #d4edda;
            color: #155724;
        }

        .badge-recharge {
            background: #fff3cd;
            color: #856404;
        }

        .badge-bill {
            background: #cce5ff;
            color: #004085;
        }

        .amount {
            font-weight: bold;
            color: #1a1a2e;
        }

        .amount.positive {
            color: #28a745;
        }

        .amount.negative {
            color: #dc3545;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-primary {
            background: #e94560;
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid #e94560;
            color: #e94560;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: #999;
        }

        .empty-state .icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        /* Transaction Detail Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .detail-label {
            color: #666;
            font-size: 14px;
        }

        .detail-value {
            font-weight: 600;
            color: #1a1a2e;
        }

        @media (max-width: 768px) {
            .page-header {
                flex-direction: column;
                gap: 15px;
            }

            .filter-tabs {
                flex-wrap: wrap;
            }

            table {
                font-size: 14px;
            }

            th,
            td {
                padding: 10px;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <h1>ğŸ’³ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h1>
        <div class="navbar-links">
            <a href="index.html">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h2>ğŸ“Š Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h2>
            <button class="btn btn-primary" onclick="refreshTransactions()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
        </div>

        <div class="stats-row">
            <div class="stat-box transfers">
                <h4>Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª</h4>
                <div class="value" id="transferCount">0</div>
            </div>
            <div class="stat-box recharges">
                <h4>Ø´Ø­Ù† Ø§Ù„Ø±ØµÙŠØ¯</h4>
                <div class="value" id="rechargeCount">0</div>
            </div>
            <div class="stat-box total">
                <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h4>
                <div class="value" id="totalCount">0</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h3>
                <div class="filter-tabs">
                    <button class="filter-tab active" data-filter="all">Ø§Ù„ÙƒÙ„</button>
                    <button class="filter-tab" data-filter="transfer">ØªØ­ÙˆÙŠÙ„Ø§Øª</button>
                    <button class="filter-tab" data-filter="recharge">Ø´Ø­Ù†</button>
                </div>
            </div>
            <div class="card-body">
                <div class="loading" id="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª...</div>
                <div class="empty-state" id="emptyState" style="display: none;">
                    <div class="icon">ğŸ“­</div>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</p>
                </div>
                <table id="transactionsTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Ø§Ù„Ù†ÙˆØ¹</th>
                            <th>Ù…Ù† Ø­Ø³Ø§Ø¨</th>
                            <th>Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨</th>
                            <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Transaction Detail Modal -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="transactionDetails"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let allTransactions = [];

        // Check login
        function checkLogin() {
            const loginTime = localStorage.getItem('adminLoginTime');
            if (!loginTime || (Date.now() - parseInt(loginTime)) > 3600000) {
                window.location.href = '/admin/login.html';
            }
        }
        checkLogin();

        async function loadTransactions() {
            try {
                const response = await fetch(`${API_BASE}/admin/transactions`);
                const data = await response.json();

                document.getElementById('loading').style.display = 'none';

                allTransactions = data.transactions || [];

                if (allTransactions.length === 0) {
                    document.getElementById('emptyState').style.display = 'block';
                    return;
                }

                document.getElementById('transactionsTable').style.display = 'table';

                // Count by type
                const transfers = allTransactions.filter(t => t.type === 'transfer' || t.type === 'ØªØ­ÙˆÙŠÙ„').length;
                const recharges = allTransactions.filter(t => t.type === 'recharge' || t.type === 'Ø´Ø­Ù†').length;

                document.getElementById('transferCount').textContent = transfers;
                document.getElementById('rechargeCount').textContent = recharges;
                document.getElementById('totalCount').textContent = allTransactions.length;

                renderTransactions(allTransactions);
            } catch (error) {
                console.error('Error loading transactions:', error);
                document.getElementById('loading').textContent = 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª';
            }
        }

        function renderTransactions(transactions) {
            const tbody = document.getElementById('transactionsBody');
            tbody.innerHTML = '';

            transactions.forEach((tx, index) => {
                const date = tx.timestamp || tx.date || tx.created_at;
                const formattedDate = date ? formatDate(date) : '-';
                const type = tx.type || 'unknown';
                const typeLabel = getTypeLabel(type);
                const typeBadge = getTypeBadge(type);

                const fromAcc = tx.from_account || tx.sender || tx.source_account || '-';
                const toAcc = tx.to_account || tx.receiver || tx.target_account || '-';

                tbody.innerHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td><span class="badge ${typeBadge}">${typeLabel}</span></td>
                        <td>${fromAcc}</td>
                        <td>${toAcc}</td>
                        <td class="amount">${(tx.amount || 0).toLocaleString()} Ø¬Ù†ÙŠÙ‡</td>
                        <td>${formattedDate}</td>
                        <td>
                            <button class="btn btn-outline" onclick="showDetails(${index})">Ø¹Ø±Ø¶</button>
                        </td>
                    </tr>
                `;
            });
        }

        function getTypeLabel(type) {
            const types = {
                'transfer': 'ØªØ­ÙˆÙŠÙ„',
                'ØªØ­ÙˆÙŠÙ„': 'ØªØ­ÙˆÙŠÙ„',
                'recharge': 'Ø´Ø­Ù†',
                'Ø´Ø­Ù†': 'Ø´Ø­Ù†',
                'bill': 'ÙØ§ØªÙˆØ±Ø©',
                'ÙØ§ØªÙˆØ±Ø©': 'ÙØ§ØªÙˆØ±Ø©'
            };
            return types[type] || type;
        }

        function getTypeBadge(type) {
            if (type === 'transfer' || type === 'ØªØ­ÙˆÙŠÙ„') return 'badge-transfer';
            if (type === 'recharge' || type === 'Ø´Ø­Ù†') return 'badge-recharge';
            if (type === 'bill' || type === 'ÙØ§ØªÙˆØ±Ø©') return 'badge-bill';
            return 'badge-transfer';
        }

        function formatDate(date) {
            if (date._seconds) {
                return new Date(date._seconds * 1000).toLocaleString('ar');
            }
            return new Date(date).toLocaleString('ar');
        }

        function showDetails(index) {
            const tx = allTransactions[index];
            const detailsDiv = document.getElementById('transactionDetails');

            detailsDiv.innerHTML = `
                <div class="detail-row">
                    <span class="detail-label">Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</span>
                    <span class="detail-value">${tx.id || tx.transaction_id || '-'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Ø§Ù„Ù†ÙˆØ¹</span>
                    <span class="detail-value">${getTypeLabel(tx.type)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Ù…Ù† Ø­Ø³Ø§Ø¨</span>
                    <span class="detail-value">${tx.from_account || tx.sender || tx.source_account || '-'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„</span>
                    <span class="detail-value">${tx.from_name || tx.sender_name || '-'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨</span>
                    <span class="detail-value">${tx.to_account || tx.receiver || tx.target_account || '-'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…</span>
                    <span class="detail-value">${tx.to_name || tx.receiver_name || '-'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Ø§Ù„Ù…Ø¨Ù„Øº</span>
                    <span class="detail-value" style="color: #28a745; font-size: 20px;">${(tx.amount || 0).toLocaleString()} Ø¬Ù†ÙŠÙ‡</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Ø§Ù„Ø±Ø³ÙˆÙ…</span>
                    <span class="detail-value">${tx.fees || 0} Ø¬Ù†ÙŠÙ‡</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Ø§Ù„ØªØ§Ø±ÙŠØ®</span>
                    <span class="detail-value">${formatDate(tx.timestamp || tx.date || tx.created_at)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</span>
                    <span class="detail-value">${tx.notes || tx.description || '-'}</span>
                </div>
            `;

            document.getElementById('detailModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        function refreshTransactions() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('transactionsTable').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
            loadTransactions();
        }

        // Filter tabs
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.addEventListener('click', function () {
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                const filter = this.dataset.filter;
                let filtered = allTransactions;

                if (filter === 'transfer') {
                    filtered = allTransactions.filter(t => t.type === 'transfer' || t.type === 'ØªØ­ÙˆÙŠÙ„');
                } else if (filter === 'recharge') {
                    filtered = allTransactions.filter(t => t.type === 'recharge' || t.type === 'Ø´Ø­Ù†');
                }

                renderTransactions(filtered);
            });
        });

        // Load initial data
        loadTransactions();
    </script>
</body>

</html>